#VRML V2.0 utf8

PROTO C3D_GuiBar [
	exposedField	SFFloat	width		1
	exposedField	SFFloat height		1
	exposedField	SFBool	enabled		TRUE
	exposedField	SFNode	texture		NULL
	exposedField	SFNode	sound		NULL
	exposedField	SFBool	on			FALSE
	exposedField	SFBool	over		FALSE
	exposedField	SFBool	active		FALSE
	exposedField	SFFloat	transparency 0
]
{
	Shape {
		geometry IndexedFaceSet	{
			coord DEF coord Coordinate {}
			texCoord TextureCoordinate {
				point [ 
					.03125 .03125
					.31250 .03125
					.31250 .03125
					.68750 .03125
					.68750 .03125
					.96875 .03125

					.03125 .31250
					.31250 .31250
					.31250 .31250
					.68750 .31250
					.68750 .31250
					.96875 .31250

					.03125 .31250
					.31250 .31250
					.31250 .31250
					.68750 .31250
					.68750 .31250
					.96875 .31250

					.03125 .68750
					.31250 .68750
					.31250 .68750
					.68750 .68750
					.68750 .68750
					.96875 .68750

					.03125 .68750
					.31250 .68750
					.31250 .68750
					.68750 .68750
					.68750 .68750
					.96875 .68750

					.03125 .96875
					.31250 .96875
					.31250 .96875
					.68750 .96875
					.68750 .96875
					.96875 .96875
				]
			}
			coordIndex [
				 0 1 7 6 -1
				 1 2 8 7 -1
				 2 3 9 8 -1
				 3 4 10 9 -1
				 4 5 11 10 -1

				 6 7 13 12 -1
				 7 8 14 13 -1
				 8 9 15 14 -1
				 9 10 16 15 -1
				 10 11 17 16 -1

				 12 13 19 18 -1
				 13 14 20 19 -1
				 14 15 21 20 -1
				 15 16 22 21 -1
				 16 17 23 22 -1

				 18 19 25 24 -1
				 19 20 26 25 -1
				 20 21 27 26 -1
				 21 22 28 27 -1
				 22 23 29 28 -1
			 
				 24 25 31 30 -1
				 25 26 32 31 -1
				 26 27 33 32 -1
				 27 28 34 33 -1
			 	 28 29 35 34 -1
			]
		}
		appearance Appearance {
			material DEF material Material {
				diffuseColor 1 1 1
				emissiveColor 1 1 1
				transparency IS	transparency
			}
			texture IS texture
			textureTransform DEF texXfrm TextureTransform { scale .5 .5 }
		}
	}

	DEF sound Sound	{
		source IS sound
		minBack 9
		minFront 9
	}

    DEF barScript Script {
		exposedField	SFFloat	width		IS	width
		exposedField	SFFloat	height		IS	height
		exposedField	SFBool	active		IS	active
		exposedField	SFBool	on			IS	on 
		exposedField	SFBool	over		IS	over
		exposedField	SFBool	enabled		IS	enabled
		field			SFNode	texXfrm		USE	texXfrm
		field			SFNode	sound		USE	sound
		field			SFNode	coord		USE	coord
		field			SFNode	material	USE	material
		field			SFFloat	lastHeight	-1
		field			SFFloat	lastWidth	-1

		directOutput TRUE

        url	"javascript:
		
		function initialize() {
			width(width);	
			height(height);	
			updateState();
		}

		function over(v) {
			updateState();
		}

		function on(v) {
			updateState();
		}

		function enabled(v) {
			updateState();
		}

		function width(v) {
			width = (v < 1) ? 1 : width;
			if (width != lastWidth) {
				updateGeometry();
				lastWidth = width;
			}
		}

		function height(v) {
			height = (v < 1) ? 1 : height;
			if (height != lastHeight) { 
				updateGeometry();
				lastHeight = height;
			}
		}

        function active(v, now) {
			if (active) {
				sound.source.startTime = now;
			}
        }

		function updateState() {
			var x = on   ? 1 : 0;
			var y = over ? 0 : 1;
			texXfrm.translation   = new SFVec2f(x, y);
			//material.transparency = enabled ? 0 : 0.5;
		}
	  
		//  y1 +--------++----------++--------+ 
		//     |30    31||32      33||34    35| 
		//     |        ||          ||        | 
		//     |        ||          ||        | 
		//     |24    25||26      27||28    29| 
		//  y2 +--------++----------++--------+ 
		//  y3 +--------++----------++--------+ 
		//     |18    19||20      21||22    23| 
		//     |        ||          ||        | 
		//     |        ||          ||        | 
		//     |        ||          ||        | 
		//     |12    13||14      15||16    17| 
		// -y3 +--------++----------++--------+ 
		// -y2 +--------++----------++--------+ 
		//     |6      7||8        9||10    11| 
		//     |        ||          ||        | 
		//     |        ||          ||        | 
		//     |0      1||2        3||4      5| 
		// -y1 +--------++----------++--------+
		//      -x1  -x2  -x3     x3  x2    x1	
		function updateGeometry() {

			var x1 = width / 2;
			var x2 = x1 - (10 / 32);
			var x3 = 6 / 32;

			var y1 = height / 2;
			var y2 = y1 - (10 / 32);
			var y3 = x3;

			var x = new MFFloat(-x1, -x2, -x3, x3, x2, x1, -x1, -x2, -x3, x3, x2, x1, -x1, -x2, -x3, x3, x2, x1, -x1, -x2, -x3, x3, x2, x1, -x1, -x2, -x3, x3, x2, x1, -x1, -x2, -x3, x3, x2, x1);
			var y = new MFFloat(-y1, -y1, -y1, -y1, -y1, -y1, -y2, -y2, -y2, -y2, -y2, -y2, -y3, -y3, -y3, -y3, -y3, -y3, y3, y3, y3, y3, y3, y3, y2, y2, y2, y2, y2, y2, y1, y1, y1, y1, y1, y1);

			var p = new MFVec3f();
			for (var i = 0; i < 36; i++) {
				p[i] = new SFVec3f(x[i], y[i], 0);
			}
			coord.point = p;
		}  
		"
    }
}



 # testing

DEF icon C3D_GuiBar {
	texture	ImageTexture { url "maps/gui_button_background.png" }
	enabled	TRUE
	width 2
	height 1
}

DEF	touch TouchSensor {}

ROUTE touch.isOver TO icon.over

DEF	scr Script {
	eventIn	SFTime touchTime
	field SFNode icon USE icon
	field SFBool on FALSE
	directOutput TRUE
	url	"javascript:
	function touchTime() {
		on = !on;
		icon.on = on;
	}
	"
}

ROUTE touch.touchTime TO scr.touchTime